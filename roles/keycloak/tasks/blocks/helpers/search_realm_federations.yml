---

- name: "Search federation {{ item[1].alias }} in keycloak"
  uri:
    url: "{{ keycloak_proxy_host }}/admin/realms/{{ item[0].name }}"
    method: GET
    headers:
      Authorization: "Bearer {{ tokens.json.access_token }}"
    status_code: 200
  register: "realm_result"
  tags:
    - "keycloak:config:realm:federations"

- set_fact:
    realm_federation_matches: "{{ realm_result.json[keycloak_federation.saml.representation_entity] | json_query(query) | default([]) }}"
  vars:
    query: '[?alias == `{{ item[1].alias }}` ].{alias: alias, internalId: internalId }'
  tags:
    - "keycloak:config:realm:federations"
