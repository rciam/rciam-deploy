---
- name: Installing a plugin
  block:
  - name: Create plugin dir with parent directories
    file:
      path: "{{keycloak_home}}/modules/system/layers/keycloak/org/keycloak/{{ item.value.name }}/main"
      state: directory

  - name: Download plugin jar
    get_url:
      url: "{{ item.value.jar_url }}"
      dest: "{{keycloak_home}}/modules/system/layers/keycloak/org/keycloak/{{ item.value.name }}/main/"

  - name: Install module.xml
    get_url:
      url: "{{ item.value.modulexml_url }}"
      dest: "{{keycloak_home}}/modules/system/layers/keycloak/org/keycloak/{{ item.value.name }}/main/"

  - name: Setup keycloak xml providers
    xml:
      path: "{{keycloak_home}}/standalone/configuration/standalone-ha.xml"
      xpath: /srv:server/srv:profile/sub:subsystem/sub:providers
      input_type: xml
      add_children:
        - "<provider>module:org.keycloak.{{ item.value.name }}</provider>"
      namespaces:
        srv: "{{ namespaces.domain }}"
        sub: "{{ namespaces.domain_server }}"

  - name: Setup keycloak xml theme modules
    xml:
      path: "{{keycloak_home}}/standalone/configuration/standalone-ha.xml"
      xpath: /srv:server/srv:profile/sub:subsystem/sub:theme
      input_type: xml
      add_children:
        - "<modules>  <module>org.keycloak.{{ item.value.name }}</module>  </modules>"
      namespaces:
        srv: "{{ namespaces.domain }}"
        sub: "{{ namespaces.domain_server }}"
    when: "{{ item.value.isTheme | default(false) }}"

  become: yes
  when: not item is undefined
  tags: "install_plugins"



